<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Uyarı Mesajları Socket.IO Testi</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      max-width: 800px; 
      margin: 0 auto; 
      padding: 20px;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: #f9f9f9;
    }
    .warning {
      background-color: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 10px;
      margin: 10px 0;
    }
    .warning-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    .warning-time {
      font-size: 0.8em;
      color: #6c757d;
    }
    .warning-admin {
      font-weight: bold;
    }
    .warning-message {
      margin-top: 5px;
    }
    .read-btn {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .connection-status {
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 4px;
    }
    .connected {
      background-color: #d4edda;
      color: #155724;
    }
    .disconnected {
      background-color: #f8d7da;
      color: #721c24;
    }
    .input-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
    }
    input {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
    }
    button {
      padding: 10px 15px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Uyarı Mesajları Socket.IO Testi</h1>
  
  <div id="connectionStatus" class="connection-status disconnected">
    Bağlantı durumu: Bağlı değil
  </div>
  
  <div class="card">
    <div class="input-group">
      <label for="tokenInput">JWT Token:</label>
      <input type="text" id="tokenInput" placeholder="JWT token giriniz">
    </div>
    <div class="input-group">
      <label for="userIdInput">Kullanıcı ID:</label>
      <input type="text" id="userIdInput" placeholder="Kullanıcı ID giriniz">
    </div>
    <button id="connectBtn">Bağlan</button>
    <button id="disconnectBtn" disabled>Bağlantıyı Kes</button>
  </div>
  
  <h2>Uyarı Mesajları</h2>
  <div id="warningsContainer"></div>
  
  <script>
    let socket;
    const serverUrl = 'http://localhost:3000';
    
    // DOM elementleri
    const tokenInput = document.getElementById('tokenInput');
    const userIdInput = document.getElementById('userIdInput');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const connectionStatus = document.getElementById('connectionStatus');
    const warningsContainer = document.getElementById('warningsContainer');
    
    // Socket.IO bağlantısını başlat
    connectBtn.addEventListener('click', () => {
      const token = tokenInput.value.trim();
      const userId = userIdInput.value.trim();
      
      if (!token || !userId) {
        alert('Token ve Kullanıcı ID alanları zorunludur!');
        return;
      }
      
      try {
        // Önceki bağlantıyı kapat
        if (socket) {
          socket.disconnect();
        }
        
        // Yeni bağlantı oluştur
        socket = io(serverUrl);
        
        // Bağlantı olayları
        socket.on('connect', () => {
          connectionStatus.textContent = 'Bağlantı durumu: Bağlandı';
          connectionStatus.className = 'connection-status connected';
          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
          
          // Kimlik doğrulama yap
          socket.emit('authenticate', { token, userId });
          console.log('Socket.IO bağlantısı kuruldu, kimlik doğrulama yapılıyor...');
        });
        
        socket.on('disconnect', () => {
          connectionStatus.textContent = 'Bağlantı durumu: Bağlantı kesildi';
          connectionStatus.className = 'connection-status disconnected';
          connectBtn.disabled = false;
          disconnectBtn.disabled = true;
          console.log('Socket.IO bağlantısı kesildi');
        });
        
        socket.on('error', (error) => {
          console.error('Socket hatası:', error);
          alert(`Hata: ${error.message}`);
        });
        
        socket.on('authenticated', (data) => {
          console.log('Kimlik doğrulama başarılı:', data);
          alert(`${data.userId} kullanıcısı olarak kimlik doğrulama başarılı!`);
        });
        
        // Uyarı mesajları olayları
        socket.on('unread_warnings', (data) => {
          console.log('Okunmamış uyarılar alındı:', data);
          renderWarnings(data.warnings);
        });
        
        socket.on('new_warning', (warning) => {
          console.log('Yeni uyarı alındı:', warning);
          renderWarning(warning);
        });
        
        socket.on('warning_read', (data) => {
          console.log('Uyarı okundu işaretlendi:', data);
          if (data.success) {
            const warningElement = document.querySelector(`[data-warning-id="${data.warningId}"]`);
            if (warningElement) {
              warningElement.style.opacity = '0.6';
              const readBtn = warningElement.querySelector('.read-btn');
              if (readBtn) {
                readBtn.disabled = true;
                readBtn.textContent = 'Okundu';
              }
            }
          }
        });
        
      } catch (error) {
        console.error('Socket.IO bağlantı hatası:', error);
        alert(`Bağlantı hatası: ${error.message}`);
      }
    });
    
    // Bağlantıyı kapat
    disconnectBtn.addEventListener('click', () => {
      if (socket) {
        socket.disconnect();
      }
    });
    
    // Uyarı mesajlarını göster
    function renderWarnings(warnings) {
      warningsContainer.innerHTML = '';
      
      if (!warnings || warnings.length === 0) {
        warningsContainer.innerHTML = '<p>Uyarı mesajı bulunamadı.</p>';
        return;
      }
      
      warnings.forEach(warning => {
        renderWarning(warning);
      });
    }
    
    // Tek bir uyarı mesajını göster
    function renderWarning(warning) {
      const warningElement = document.createElement('div');
      warningElement.className = 'warning';
      warningElement.dataset.warningId = warning.id;
      
      const adminName = warning.admin ? 
        `${warning.admin.first_name} ${warning.admin.last_name}` : 
        'Admin';
      
      const sentDate = new Date(warning.sent_at).toLocaleString('tr-TR');
      
      warningElement.innerHTML = `
        <div class="warning-header">
          <span class="warning-admin">${adminName}</span>
          <span class="warning-time">${sentDate}</span>
        </div>
        <div class="warning-message">${warning.message}</div>
        <button class="read-btn" ${warning.is_read ? 'disabled' : ''} onclick="markWarningAsRead('${warning.id}')">
          ${warning.is_read ? 'Okundu' : 'Okundu İşaretle'}
        </button>
      `;
      
      warningsContainer.prepend(warningElement);
    }
    
    // Uyarıyı okundu olarak işaretle
    function markWarningAsRead(warningId) {
      if (socket && socket.connected) {
        socket.emit('mark_warning_read', { warningId });
      }
    }
  </script>
</body>
</html> 